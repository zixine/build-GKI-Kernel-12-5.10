name: GKI Kernel Build - Wild KernelSU

on:
  workflow_dispatch:
    inputs:
      android_version:
        description: "Versi Android Common Kernel"
        required: true
        default: "common-android12-5.10"
      manifest_url:
        description: "Manifest URL"
        required: true
        default: "https://android.googlesource.com/kernel/manifest"

jobs:
  build-kernel:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
    - name: Checkout Workflow
      uses: actions/checkout@v4

    - name: Free Disk Space
      run: |
        echo "Membersihkan ruang disk..."
        sudo rm -rf /usr/share/dotnet
        sudo rm -rf /opt/ghc
        sudo rm -rf "/usr/local/share/boost"
        sudo rm -rf "$AGENT_TOOLSDIRECTORY"
        echo "Ruang disk setelah pembersihan:"
        df -h

    - name: Install Dependencies
      run: |
        echo "Menginstall dependencies..."
        sudo apt-get update
        sudo apt-get install -y git curl repo build-essential bc bison flex libssl-dev \
          libelf-dev python3 python3-pip unzip zip rsync libncurses-dev lld ccache \
          cmake ninja-build

    - name: Setup Git Config
      run: |
        git config --global user.email "bot@github.com"
        git config --global user.name "GitHub Action"

    - name: Initialize & Sync Kernel Source
      run: |
        mkdir -p android-kernel
        cd android-kernel
        
        echo "Inisialisasi Repo untuk ${{ inputs.android_version }}..."
        repo init --depth=1 -u ${{ inputs.manifest_url }} -b ${{ inputs.android_version }}
        
        echo "Syncing repo (ini mungkin memakan waktu)..."
        repo sync -c -j$(nproc --all) --no-tags --fail-fast

    - name: Setup Custom Clang 20 (Optimization)
      working-directory: android-kernel
      run: |
        echo "=== Setup Custom Clang 20 (r547379) ==="
        
        if [ -d "prebuilts-master/clang/host/linux-x86" ]; then
          PREBUILTS_ROOT="prebuilts-master"
        elif [ -d "prebuilts/clang/host/linux-x86" ]; then
          PREBUILTS_ROOT="prebuilts"
        else
          PREBUILTS_ROOT="prebuilts-master"
          mkdir -p "$PREBUILTS_ROOT/clang/host/linux-x86"
        fi
        
        NEW_CLANG_VER="clang-r547379"
        CLANG_URL="https://android.googlesource.com/platform/prebuilts/clang/host/linux-x86/+archive/62cdcefa89e31af2d72c366e8b5ef8db84caea62/clang-r547379.tar.gz"
        NEW_CLANG_DIR="$PREBUILTS_ROOT/clang/host/linux-x86/$NEW_CLANG_VER"

        echo "Downloading $NEW_CLANG_VER..."
        mkdir -p "$NEW_CLANG_DIR"
        curl -L "$CLANG_URL" | tar -xz -C "$NEW_CLANG_DIR"
        
        # Deteksi dan Symlink agar build system tidak bingung
        cd common
        OLD_CLANG_VER=$(grep "CLANG_VERSION=" build.config.common | head -n 1 | cut -d= -f2 | tr -d '"' | tr -d ' ')
        if [ -z "$OLD_CLANG_VER" ]; then OLD_CLANG_VER="r416183b"; fi
        if [[ "$OLD_CLANG_VER" != clang-* ]]; then OLD_CLANG_DIR_NAME="clang-$OLD_CLANG_VER"; else OLD_CLANG_DIR_NAME="$OLD_CLANG_VER"; fi
        cd ..

        TARGET_DIR="$PREBUILTS_ROOT/clang/host/linux-x86/$OLD_CLANG_DIR_NAME"
        if [ -d "$TARGET_DIR" ] || [ -L "$TARGET_DIR" ]; then rm -rf "$TARGET_DIR"; fi
        
        cd "$PREBUILTS_ROOT/clang/host/linux-x86"
        ln -sf "$NEW_CLANG_VER" "$OLD_CLANG_DIR_NAME"
        cd - > /dev/null

        # Patch config agar menggunakan clang baru
        cd common
        sed -i "s/$OLD_CLANG_DIR_NAME/$NEW_CLANG_VER/g" build.config.common 2>/dev/null || true
        sed -i "s/$OLD_CLANG_DIR_NAME/$NEW_CLANG_VER/g" build.config.gki.aarch64 2>/dev/null || true
        
        echo "CLANG_BIN_PATH=$GITHUB_WORKSPACE/android-kernel/$NEW_CLANG_DIR/bin" >> $GITHUB_ENV
        echo "Setup Clang Selesai."

    - name: Setup Wild KernelSU
      working-directory: android-kernel
      run: |
        echo "=== Menjalankan Setup Wild KernelSU ==="
        cd common
        curl -LSs "https://raw.githubusercontent.com/WildKernels/Wild_KSU/wild/kernel/setup.sh" | bash -s wild
        echo "Wild KernelSU Setup Selesai."

    - name: Setup SuSFS (Manual)
      working-directory: android-kernel/common
      run: |
        echo "=== Menjalankan Setup SuSFS ==="
        git clone https://gitlab.com/simonpunk/susfs4ksu.git -b gki-android12-5.10 susfs-git
        cp -r susfs-git/kernel_patches/include/* include/
        cp -r susfs-git/kernel_patches/fs/* fs/
        cp susfs-git/kernel_patches/50_add_susfs_in_gki-android12-5.10.patch .
        patch -p1 < 50_add_susfs_in_gki-android12-5.10.patch
        echo "[âœ“] SUSFS Core Patched & Enabled"

    - name: Apply Xiaomi Compatibility Patches
      working-directory: android-kernel/common
      run: |
        echo "Menerapkan patch kompatibilitas Xiaomi..."
        sed -i '/pr_warn.*disagrees about version of symbol.*/,+1 s/.*/return 1;/' kernel/module.c
        sed -i '/^static int drm_atomic_check_valid_clones/,/^}/d' drivers/gpu/drm/drm_atomic_helper.c
        sed -i '/ret = drm_atomic_check_valid_clones/,/return ret;/d' drivers/gpu/drm/drm_atomic_helper.c

    - name: Configure SuSFS & Stealth Features (SAFE MODE)
      working-directory: android-kernel/common
      run: |
        echo "Menambahkan konfigurasi SuSFS dan Stealth ke defconfig..."
        DEFCONFIG="arch/arm64/configs/gki_defconfig"
        
        # Disable check_defconfig agar build tidak error karena perubahan config
        sed -i 's/check_defconfig//' build.config.gki
        
        # PENTING: Jangan disable ABI Check di level config file, 
        # biarkan env var yang menanganinya agar kita tahu kalau ada simbol penting yang hilang.
        
        cat <<EOF >> "$DEFCONFIG"
        # --- Config Wild KernelSU ---
        CONFIG_KSU=y
        CONFIG_KPM=n
        CONFIG_KSU_MANUAL_HOOK=y
        CONFIG_KSU_KPROBES_HOOK=n
        
        # --- SUSFS Configuration ---
        CONFIG_KSU_SUSFS=y
        CONFIG_KSU_SUSFS_HAS_MAGIC_MOUNT=y
        CONFIG_KSU_SUSFS_SUS_PATH=y
        CONFIG_KSU_SUSFS_SUS_MOUNT=y
        CONFIG_KSU_SUSFS_AUTO_ADD_SUS_KSU_DEFAULT_MOUNT=y
        CONFIG_KSU_SUSFS_AUTO_ADD_SUS_BIND_MOUNT=y
        CONFIG_KSU_SUSFS_SUS_KSTAT=y
        CONFIG_KSU_SUSFS_SUS_OVERLAYFS=y
        CONFIG_KSU_SUSFS_TRY_UMOUNT=y
        CONFIG_KSU_SUSFS_AUTO_ADD_TRY_UMOUNT_FOR_BIND_MOUNT=y
        CONFIG_KSU_SUSFS_SPOOF_UNAME=y
        CONFIG_KSU_SUSFS_ENABLE_LOG=y
        CONFIG_KSU_SUSFS_HIDE_KSU_SUSFS_SYMBOLS=y
        CONFIG_KSU_SUSFS_SPOOF_CMDLINE_OR_BOOTCONFIG=y
        CONFIG_KSU_SUSFS_OPEN_REDIRECT=y
        CONFIG_KSU_SUSFS_SUS_SU=y
        CONFIG_KSU_SUSFS_SUS_KSTAT_SPOOF_GENERIC=y
        CONFIG_KSU_SUSFS_AUTO_ADD_SUS_KSTAT=y
        
        # --- CPU & Performance (Safe) ---
        CONFIG_CPU_FREQ_GOV_SCHEDUTIL=y
        CONFIG_ENERGY_MODEL=y
        CONFIG_HZ_500=y
        
        # --- SAFE Optimization (Bootloop Fix) ---
        # Kita HAPUS baris yang mematikan fitur keamanan standar GKI
        # CONFIG_HARDENED_USERCOPY=n  <-- INI PENYEBAB BOOTLOOP (Jangan dipakai)
        # CONFIG_SLUB_DEBUG_ON=n      <-- Ini juga berisiko (Jangan dipakai)
        
        # Fitur standar yang aman diaktifkan
        CONFIG_FS_ENCRYPTION=y
        CONFIG_FS_VERITY=y
        CONFIG_RCU_FAST_NO_HZ=y
        CONFIG_RCU_NOCB_CPU=y
        CONFIG_PM_AUTOSLEEP=y
        
        # Matikan auto version suffix
        CONFIG_LOCALVERSION_AUTO=n
        EOF
        
        # Fix nama kernel agar pendek
        echo "echo ''" > scripts/setlocalversion
        chmod +x scripts/setlocalversion
        
        scripts/config --file "$DEFCONFIG" --set-str LOCALVERSION "-Zixine-Elysium-Wild-V1.2"

    - name: Build Kernel (GKI)
      working-directory: android-kernel
      run: |
        echo "Mulai Build Kernel..."
        export PATH="$CLANG_BIN_PATH:$PATH"
        export LTO=thin
        export BUILD_CONFIG=common/build.config.gki.aarch64
        
        # Disable ABI check HANYA untuk memperbolehkan simbol tambahan dari KSU/SuSFS
        # Simbol asli GKI harusnya tetap ada karena kita sudah hapus config yang berbahaya
        export KMI_SYMBOL_LIST_STRICT_MODE=0
        export KMI_ENFORCED=0
        export TRIM_NONLISTED_KMI=0
        
        build/build.sh -j$(nproc)

    - name: Package AnyKernel3
      working-directory: android-kernel
      run: |
        echo "Cloning AnyKernel3 (zixine)..."
        git clone https://github.com/zixine/anykernel.git anykernel
        
        echo "Mencari file Image hasil build..."
        find out -name Image -type f -exec cp {} anykernel/ \;
        
        if [ ! -f anykernel/Image ]; then
          echo "ERROR: File Image tidak ditemukan! Cek log build."
          exit 1
        fi
        
        echo "Membuat Zip AnyKernel3..."
        cd anykernel
        rm -rf .git
        zip -r9 ../AnyKernel3-Zixine-Elysium-Wild-V1.2.zip * -x README.md
        echo "Zip berhasil dibuat: AnyKernel3-Zixine-Elysium-Wild-V1.2.zip"

    - name: Upload Image Artifact
      uses: actions/upload-artifact@v4
      with:
        name: Image-WildKSU
        path: android-kernel/out/**/dist/Image

    - name: Upload AnyKernel3 Zip
      uses: actions/upload-artifact@v4
      with:
        name: AnyKernel3-Zip
        path: android-kernel/AnyKernel3-Zixine-Elysium-Wild-V1.2.zip

    - name: Release to External Repository
      uses: softprops/action-gh-release@v2
      if: success()
      with:
        token: ${{ secrets.RELEASE_TOKEN }}
        repository: zixine/Kernel-GKI-12-5.10-release
        tag_name: "v${{ github.run_number }}-wildksu-safe"
        name: "WildKSU GKI Build v${{ github.run_number }} (Safe Mode)"
        body: |
          ## Wild KernelSU GKI Build (Safe Mode - Fix Bootloop)
          
          **Android Version**: ${{ inputs.android_version }}
          **Kernel Name**: Zixine-Elysium-Wild-V1.2
          **Build ID**: ${{ github.run_number }}
          
          ### Features Included:
          - KernelSU (Wild Version)
          - SuSFS Stealth Mode Enabled
          - Xiaomi Compatibility Patches
          - Clang 20 Optimized
          - **Bootloop Fix**: Reverted risky memory optimizations (Hardened Usercopy enabled).
          
          _Automated build release._
        files: |
          android-kernel/AnyKernel3-Zixine-Elysium-Wild-V1.2.zip
          android-kernel/out/**/dist/Image
