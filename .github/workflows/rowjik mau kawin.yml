name: Zixine GKI Builder (Stable & Fix Bootloop)

on:
  workflow_dispatch:
    inputs:
      kernel_name:
        description: 'Nama Kernel'
        required: false
        default: ''
        type: string
      clang_version:
        description: 'Versi Compiler Clang'
        default: 'clang-r416183b'
      android_version:
        description: "Versi Android Common Kernel"
        required: true
        default: "common-android12-5.10"

jobs:
  build-kernel:
    name: Build Kernel
    runs-on: ubuntu-22.04
    permissions:
      contents: write

    steps:
    - name: Environment Preparation
      uses: easimon/maximize-build-space@master
      with:
        root-reserve-mb: 8192
        swap-size-mb: 10240
        remove-dotnet: 'true'
        remove-android: 'true'
        remove-codeql: 'true'

    - name: Checkout Workflow
      uses: actions/checkout@v4

    - name: Install Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y git curl repo build-essential bc bison flex libssl-dev \
          libelf-dev python3 python3-pip unzip zip rsync libncurses-dev lld ccache \
          cmake ninja-build

    - name: Setup Git Config
      run: |
        git config --global user.email "bot@github.com"
        git config --global user.name "Zixine Builder"

    - name: Initialize & Sync Kernel Source
      run: |
        mkdir -p android-kernel
        cd android-kernel
        repo init --depth=1 -u https://android.googlesource.com/kernel/manifest -b ${{ inputs.android_version }}
        repo sync -c -j$(nproc --all) --no-tags --fail-fast
        
    - name: Inject SoC Optimization
      working-directory: gki/common
      run: |
          echo "[SoC] Injecting Snapdragon Optimization (Melt-Rebase)..."
          TARGET_FILE="drivers/cpufreq/qcom-cpufreq-hw.c"
          PATCH_SOURCE="https://raw.githubusercontent.com/Pzqqt/android_kernel_xiaomi_marble/refs/heads/melt-rebase/drivers/cpufreq/qcom-cpufreq-hw.c"
          
          if [ ! -f "$TARGET_FILE" ]; then
            echo "üñïError: Target driver not found!" && exit 1
          fi
          
          curl -L "$PATCH_SOURCE" -o /tmp/patch_qcom.c
          grep -q "qcom_cpufreq_hw" /tmp/patch_qcom.c || exit 1
          cp /tmp/patch_qcom.c "$TARGET_FILE"
          echo "üíÄüíÄüíÄOptimization Applied."

    - name: Setup Compiler (Symlink Trick)
      working-directory: gki
      run: |
          mkdir -p prebuilts-master/clang/host/linux-x86
          ACTUAL_VER="clang-r416183b"
          ACTUAL_URL="https://android.googlesource.com/platform/prebuilts/clang/host/linux-x86/+archive/refs/heads/master-kernel-build-2021/clang-r416183b.tar.gz"
          EXPECTED_VER="clang-r563880b"          
          echo "‚¨áÔ∏è Downloading Clang 12 ($ACTUAL_VER)..."
          mkdir -p "prebuilts-master/clang/host/linux-x86/$ACTUAL_VER"
          curl -L "$ACTUAL_URL" | tar -xz -C "prebuilts-master/clang/host/linux-x86/$ACTUAL_VER"          
          echo "üîó Symlinking $EXPECTED_VER -> $ACTUAL_VER..."
          cd prebuilts-master/clang/host/linux-x86
          rm -rf "$EXPECTED_VER" # Hapus jika ada folder asli/kosong
          ln -s "$ACTUAL_VER" "$EXPECTED_VER"
          
          echo "‚úÖ Compiler Ready. System thinks it's $EXPECTED_VER but it's $ACTUAL_VER."

    - name: Clean & Setup Wild KernelSU
      working-directory: android-kernel/common
      run: |
        echo "üßπ Membersihkan driver KernelSU lama (Pencegah Konflik/Bootloop)..."
        rm -rf drivers/staging/kernelsu drivers/kernelsu KernelSU
        
        echo "‚¨áÔ∏è Setup Wild KernelSU..."
        curl -LSs "https://raw.githubusercontent.com/WildKernels/Wild_KSU/wild/kernel/setup.sh" | bash -s wild

    - name: Setup SuSFS
      working-directory: android-kernel/common
      run: |
        git clone https://gitlab.com/simonpunk/susfs4ksu.git -b gki-android12-5.10 susfs-git
        cp -r susfs-git/kernel_patches/include/* include/
        cp -r susfs-git/kernel_patches/fs/* fs/
        cp susfs-git/kernel_patches/50_add_susfs_in_gki-android12-5.10.patch .
        patch -p1 < 50_add_susfs_in_gki-android12-5.10.patch

    - name: Apply Critical Bootloop Fixes
      working-directory: android-kernel/common
      run: |
        echo "üîß Fixing Stack Protector & Xiaomi Compat..."
        # Patch Kconfig untuk Stack Protector (Sering bikin bootloop di GKI Custom)
        sed -i '/config STACKPROTECTOR_PER_TASK/{n;s/def_bool y/bool "Stack Protector per task"\n\tdefault y/;}' arch/arm64/Kconfig
        
        # Patch Xiaomi
        sed -i '/pr_warn.*disagrees about version of symbol.*/,+1 s/.*/return 1;/' kernel/module.c
        sed -i '/^static int drm_atomic_check_valid_clones/,/^}/d' drivers/gpu/drm/drm_atomic_helper.c
        sed -i '/ret = drm_atomic_check_valid_clones/,/return ret;/d' drivers/gpu/drm/drm_atomic_helper.c
        
        # Matikan check_defconfig
        sed -i 's/check_defconfig//' build.config.gki

    - name: Configure Kernel (Safe Mode)
      working-directory: android-kernel/common
      run: |
        DEFCONFIG="arch/arm64/configs/gki_defconfig"
        
        # --- KONFIGURASI AMAN (Anti-Bootloop) ---
        # Kita tidak mematikan HARDENED_USERCOPY agar simbol driver vendor tetap ada
        
        cat <<EOF >> "$DEFCONFIG"
        CONFIG_KSU=y
        CONFIG_KPM=n
        CONFIG_KSU_MANUAL_HOOK=y
        CONFIG_KSU_KPROBES_HOOK=n
        
        # SuSFS
        CONFIG_KSU_SUSFS=y
        CONFIG_KSU_SUSFS_HAS_MAGIC_MOUNT=y
        CONFIG_KSU_SUSFS_SUS_PATH=y
        CONFIG_KSU_SUSFS_SUS_MOUNT=y
        CONFIG_KSU_SUSFS_AUTO_ADD_SUS_KSU_DEFAULT_MOUNT=y
        CONFIG_KSU_SUSFS_AUTO_ADD_SUS_BIND_MOUNT=y
        CONFIG_KSU_SUSFS_SUS_KSTAT=y
        CONFIG_KSU_SUSFS_SUS_OVERLAYFS=y
        CONFIG_KSU_SUSFS_TRY_UMOUNT=y
        CONFIG_KSU_SUSFS_AUTO_ADD_TRY_UMOUNT_FOR_BIND_MOUNT=y
        CONFIG_KSU_SUSFS_SPOOF_UNAME=y
        CONFIG_KSU_SUSFS_ENABLE_LOG=y
        CONFIG_KSU_SUSFS_HIDE_KSU_SUSFS_SYMBOLS=y
        CONFIG_KSU_SUSFS_SPOOF_CMDLINE_OR_BOOTCONFIG=y
        CONFIG_KSU_SUSFS_OPEN_REDIRECT=y
        CONFIG_KSU_SUSFS_SUS_SU=y
        CONFIG_KSU_SUSFS_SUS_KSTAT_SPOOF_GENERIC=y
        CONFIG_KSU_SUSFS_AUTO_ADD_SUS_KSTAT=y
        
        # Power & Safety
        CONFIG_HZ_300=y
        CONFIG_FS_ENCRYPTION=y
        CONFIG_FS_VERITY=y
        CONFIG_PM_AUTOSLEEP=y
        CONFIG_PM_WAKELOCKS=y
        
        # Bootloop Prevention
        # CONFIG_STACKPROTECTOR_PER_TASK is not set
        CONFIG_LOCALVERSION_AUTO=n
        EOF
        
        # --- FIX NAMA KERNEL ---
        # Menggunakan metode 'zixine' (Timpa Makefile) untuk menghindari limit 64-char
        NAME="${{ inputs.kernel_name }}"
        echo "" > scripts/setlocalversion
        
        # Cek apakah Makefile punya EXTRAVERSION, kalau ada ganti, kalau tidak tambah
        if grep -q '^EXTRAVERSION *=' Makefile; then
          sed -i "s/^EXTRAVERSION *=.*/EXTRAVERSION = -${NAME}-/" Makefile
        else
          echo "EXTRAVERSION = -${NAME}-" >> Makefile
        fi

    - name: Build Kernel
      working-directory: android-kernel
      run: |
        echo "Mulai Build Kernel..."
        export PATH="$CLANG_BIN_PATH:$PATH"
        export LTO=thin
        export BUILD_CONFIG=common/build.config.gki.aarch64
        
        # Disable Strict ABI Check (Wajib untuk custom GKI)
        export KMI_SYMBOL_LIST_STRICT_MODE=0
        export KMI_ENFORCED=0
        export TRIM_NONLISTED_KMI=0
        
        build/build.sh -j$(nproc)

    - name: Packaging & Release
      env:
          GH_TOKEN: ${{ secrets.GH_PAT }} # Menggunakan Token PAT yang kamu buat
      run: |
          # 1. SETUP NAMA FILE
          BASE_VER=$(make -s kernelversion -C gki/common | tr -d '\n\r')
          FULL_VER=$(make -s kernelversion -C gki/common | tr -d '\n\r')
          DATE=$(date +"%Y%m%d")
          
          KNAME="${{ github.event.inputs.kernel_name }}"
          [ -z "$KNAME" ] && KNAME="Zixine"
          
          # Nama File Akhir
          ZIP_NAME="AK3-Zixine-Wild-${KNAME}-${{ matrix.profile }}-${DATE}-${BASE_VER}-${TAG}.zip"
          
          # 2. CLONE CUSTOM ANYKERNEL KAMU
          # GANTI URL DI BAWAH INI DENGAN LINK REPO ANYKERNEL KAMU SENDIRI
          AK3_REPO="https://github.com/zixine/anykernel" 
          git clone -q --depth=1 "$AK3_REPO" -b main anykernel
          
          # 3. MASUKKAN IMAGE & ZIP
          cp gki/out/android12-5.10/dist/Image anykernel/
          
          # Inject versi kernel ke script (opsional, biar rapi di TWRP)
          sed -i "s|kernel.string=.*|kernel.string=${FULL_VER}|g" anykernel/anykernel.sh
          
          cd anykernel
          # Pastikan script punya izin eksekusi sebelum di-zip
          chmod +x anykernel.sh tools/magiskboot tools/ak3-core.sh META-INF/com/google/android/update-binary
          
          zip -r9 "../$ZIP_NAME" ./*
          cd ..
          
          # 4. UPLOAD KE REPOSITORY RELEASE (CROSS-REPO)
          TARGET_REPO="zixine/Kernel-GKI-12-5.10-release"
          RELEASE_TAG="${KNAME}-${DATE}"
          
          echo "üöÄ Uploading $ZIP_NAME to $TARGET_REPO ($RELEASE_TAG)..."
          
          # Logic: Cek apakah Release Tag sudah ada?
          # Jika sudah ada (misal job Snapdragon selesai duluan), kita cuma upload asset.
          # Jika belum ada, kita buat release baru.
          
          if gh release view "$RELEASE_TAG" --repo "$TARGET_REPO" > /dev/null 2>&1; then
            echo "‚úÖ Release exists, uploading asset..."
            gh release upload "$RELEASE_TAG" "$ZIP_NAME" --repo "$TARGET_REPO" --clobber
          else
            echo "üÜï Creating new release..."
            # Catatan Rilis
            NOTES="Build Date: $(date)
            Clang: ${{ github.event.inputs.clang_version }}
            Status: ${{ github.event.inputs.release_status }}"
            
            gh release create "$RELEASE_TAG" "$ZIP_NAME" \
              --repo "$TARGET_REPO" \
              --title "$RELEASE_TAG" \
              --notes "$NOTES" \
              --prerelease=$([ "${{ github.event.inputs.release_status }}" == "BETA" ] && echo "true" || echo "false")
          fi
          
          echo "üéâ Done: $ZIP_NAME"
