name: GKI Kernel Build - Wild KernelSU

on:
  workflow_dispatch:
    inputs:
      android_version:
        description: "Versi Android Common Kernel"
        required: true
        default: "common-android12-5.10"
      manifest_url:
        description: "Manifest URL"
        required: true
        default: "https://android.googlesource.com/kernel/manifest"

jobs:
  build-kernel:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
    - name: Checkout Workflow
      uses: actions/checkout@v4

    - name: Free Disk Space
      run: |
        echo "Membersihkan ruang disk..."
        sudo rm -rf /usr/share/dotnet
        sudo rm -rf /opt/ghc
        sudo rm -rf "/usr/local/share/boost"
        sudo rm -rf "$AGENT_TOOLSDIRECTORY"
        echo "Ruang disk setelah pembersihan:"
        df -h

    - name: Install Dependencies
      run: |
        echo "Menginstall dependencies..."
        sudo apt-get update
        sudo apt-get install -y git curl repo build-essential bc bison flex libssl-dev \
          libelf-dev python3 python3-pip unzip zip rsync libncurses-dev lld ccache \
          cmake ninja-build

    - name: Setup Git Config
      run: |
        git config --global user.email "bot@github.com"
        git config --global user.name "GitHub Action"

    - name: Initialize & Sync Kernel Source
      run: |
        mkdir -p android-kernel
        cd android-kernel
        
        echo "Inisialisasi Repo untuk ${{ inputs.android_version }}..."
        repo init --depth=1 -u ${{ inputs.manifest_url }} -b ${{ inputs.android_version }}
        
        echo "Syncing repo (ini mungkin memakan waktu)..."
        repo sync -c -j$(nproc --all) --no-tags --fail-fast

    - name: Setup Custom Clang 20 (Optimization)
      working-directory: android-kernel
      run: |
        echo "=== Setup Custom Clang 20 (r547379) ==="
        
        # 1. Tentukan Root Prebuilts (prebuilts vs prebuilts-master)
        if [ -d "prebuilts-master/clang/host/linux-x86" ]; then
          PREBUILTS_ROOT="prebuilts-master"
        elif [ -d "prebuilts/clang/host/linux-x86" ]; then
          PREBUILTS_ROOT="prebuilts"
        else
          # Fallback
          PREBUILTS_ROOT="prebuilts-master"
          mkdir -p "$PREBUILTS_ROOT/clang/host/linux-x86"
        fi
        echo "Prebuilts Root ditemukan di: $PREBUILTS_ROOT"

        # 2. Siapkan Variabel
        NEW_CLANG_VER="clang-r547379"
        CLANG_URL="https://android.googlesource.com/platform/prebuilts/clang/host/linux-x86/+archive/62cdcefa89e31af2d72c366e8b5ef8db84caea62/clang-r547379.tar.gz"
        NEW_CLANG_DIR="$PREBUILTS_ROOT/clang/host/linux-x86/$NEW_CLANG_VER"

        # 3. Download & Extract Clang Baru
        echo "Downloading $NEW_CLANG_VER..."
        mkdir -p "$NEW_CLANG_DIR"
        curl -L "$CLANG_URL" | tar -xz -C "$NEW_CLANG_DIR"
        
        # Verifikasi download
        if [ ! -f "$NEW_CLANG_DIR/bin/clang" ]; then
          echo "ERROR: Clang binary not found after extraction!"
          ls -R "$NEW_CLANG_DIR" | head -n 20
          exit 1
        fi

        # 4. Deteksi Versi Clang Bawaan dari Config
        # Kita baca file config untuk tahu versi mana yang diharapkan oleh build system
        cd common
        OLD_CLANG_VER=$(grep "CLANG_VERSION=" build.config.common | head -n 1 | cut -d= -f2 | tr -d '"' | tr -d ' ')
        
        # Jika tidak ketemu, gunakan default umum
        if [ -z "$OLD_CLANG_VER" ]; then
           OLD_CLANG_VER="r416183b"
        fi
        
        # Normalisasi nama folder (tambahkan prefix clang- jika perlu)
        if [[ "$OLD_CLANG_VER" != clang-* ]]; then
            OLD_CLANG_DIR_NAME="clang-$OLD_CLANG_VER"
        else
            OLD_CLANG_DIR_NAME="$OLD_CLANG_VER"
        fi
        echo "Sistem mengharapkan Clang versi: $OLD_CLANG_DIR_NAME"
        cd ..

        # 5. Lakukan Symlink (Trick System)
        # Hapus folder clang yang diharapkan sistem, ganti dengan symlink ke clang baru kita
        TARGET_DIR="$PREBUILTS_ROOT/clang/host/linux-x86/$OLD_CLANG_DIR_NAME"
        
        if [ -d "$TARGET_DIR" ] || [ -L "$TARGET_DIR" ]; then
            echo "Menghapus $TARGET_DIR dan menggantinya dengan symlink ke $NEW_CLANG_VER"
            rm -rf "$TARGET_DIR"
        else
            echo "Folder target $TARGET_DIR tidak ada, membuat symlink baru..."
        fi
        
        # Buat Symlink: TARGET_DIR -> NEW_CLANG_VER
        # Kita harus masuk ke direktori parent agar symlink relatifnya benar
        cd "$PREBUILTS_ROOT/clang/host/linux-x86"
        ln -sf "$NEW_CLANG_VER" "$OLD_CLANG_DIR_NAME"
        
        # Verifikasi Symlink
        ls -l "$OLD_CLANG_DIR_NAME"
        cd - > /dev/null

        # 6. Patch Config (Safety Net)
        # Update config file untuk menunjuk ke string versi baru juga
        cd common
        sed -i "s/$OLD_CLANG_DIR_NAME/$NEW_CLANG_VER/g" build.config.common 2>/dev/null || true
        sed -i "s/$OLD_CLANG_DIR_NAME/$NEW_CLANG_VER/g" build.config.gki.aarch64 2>/dev/null || true
        
        # Simpan path bin clang ke GITHUB_ENV untuk step selanjutnya
        echo "CLANG_BIN_PATH=$GITHUB_WORKSPACE/android-kernel/$NEW_CLANG_DIR/bin" >> $GITHUB_ENV
        
        echo "Setup Clang Selesai."

    - name: Setup Wild KernelSU
      working-directory: android-kernel
      run: |
        echo "=== Menjalankan Setup Wild KernelSU ==="
        cd common
        curl -LSs "https://raw.githubusercontent.com/WildKernels/Wild_KSU/wild/kernel/setup.sh" | bash -s wild
        echo "Wild KernelSU Setup Selesai."

    - name: Setup SuSFS (Manual)
      working-directory: android-kernel/common
      run: |
        echo "=== Menjalankan Setup SuSFS ==="
        git clone https://gitlab.com/simonpunk/susfs4ksu.git -b gki-android12-5.10 susfs-git
        
        echo "Copying SuSFS headers and fs files..."
        cp -r susfs-git/kernel_patches/include/* include/
        cp -r susfs-git/kernel_patches/fs/* fs/
        
        echo "Applying SuSFS Core Patch..."
        cp susfs-git/kernel_patches/50_add_susfs_in_gki-android12-5.10.patch .
        patch -p1 < 50_add_susfs_in_gki-android12-5.10.patch
        echo "[âœ“] SUSFS Core Patched & Enabled"

    - name: Apply Xiaomi Compatibility Patches
      working-directory: android-kernel/common
      run: |
        echo "Menerapkan patch kompatibilitas Xiaomi..."
        sed -i '/pr_warn.*disagrees about version of symbol.*/,+1 s/.*/return 1;/' kernel/module.c
        sed -i '/^static int drm_atomic_check_valid_clones/,/^}/d' drivers/gpu/drm/drm_atomic_helper.c
        sed -i '/ret = drm_atomic_check_valid_clones/,/return ret;/d' drivers/gpu/drm/drm_atomic_helper.c

    - name: Configure SuSFS & Stealth Features
      working-directory: android-kernel/common
      run: |
        echo "Menambahkan konfigurasi SuSFS dan Stealth ke defconfig..."
        DEFCONFIG="arch/arm64/configs/gki_defconfig"
        
        # --- FIX UTAMA: Disable check_defconfig ---
        echo "Mematikan check_defconfig..."
        sed -i 's/check_defconfig//' build.config.gki
        
        cat <<EOF >> "$DEFCONFIG"
        # --- Config dari Script KowSuSu ---
        CONFIG_KSU=y
        CONFIG_KPM=n
        CONFIG_KSU_MANUAL_HOOK=y
        CONFIG_KSU_KPROBES_HOOK=n
        
        # SUSFS Configuration
        CONFIG_KSU_SUSFS=y
        CONFIG_KSU_SUSFS_HAS_MAGIC_MOUNT=y
        CONFIG_KSU_SUSFS_SUS_PATH=y
        CONFIG_KSU_SUSFS_SUS_MOUNT=y
        CONFIG_KSU_SUSFS_AUTO_ADD_SUS_KSU_DEFAULT_MOUNT=y
        CONFIG_KSU_SUSFS_AUTO_ADD_SUS_BIND_MOUNT=y
        CONFIG_KSU_SUSFS_SUS_KSTAT=y
        CONFIG_KSU_SUSFS_SUS_OVERLAYFS=y
        CONFIG_KSU_SUSFS_TRY_UMOUNT=y
        CONFIG_KSU_SUSFS_AUTO_ADD_TRY_UMOUNT_FOR_BIND_MOUNT=y
        CONFIG_KSU_SUSFS_SPOOF_UNAME=y
        CONFIG_KSU_SUSFS_ENABLE_LOG=y
        CONFIG_KSU_SUSFS_HIDE_KSU_SUSFS_SYMBOLS=y
        CONFIG_KSU_SUSFS_SPOOF_CMDLINE_OR_BOOTCONFIG=y
        CONFIG_KSU_SUSFS_OPEN_REDIRECT=y
        
        # CPU & Performance
        CONFIG_CPU_FREQ_GOV_SCHEDUTIL=y
        CONFIG_CPU_FREQ_DEFAULT_GOV_SCHEDUTIL=y
        CONFIG_ENERGY_MODEL=y
        
        # Additional Stealth
        CONFIG_KSU_SUSFS_SUS_SU=y
        CONFIG_KSU_SUSFS_SUS_KSTAT_SPOOF_GENERIC=y
        CONFIG_KSU_SUSFS_AUTO_ADD_SUS_KSTAT=y
        
        CONFIG_HZ_300=y
        CONFIG_CPU_FREQ=y
        CONFIG_HIGH_RES_TIMERS=y
        CONFIG_CLEANCACHE=y
        CONFIG_TMPFS_XATTR=y
        CONFIG_TMPFS_POSIX_ACL=y
        
        # User Optimization Configs
        CONFIG_FS_ENCRYPTION=y
        CONFIG_FS_VERITY=y
        CONFIG_SLUB_DEBUG_ON=n
        CONFIG_HARDENED_USERCOPY=n
        CONFIG_RCU_FAST_NO_HZ=y
        CONFIG_RCU_NOCB_CPU=y
        CONFIG_PM_AUTOSLEEP=y
        CONFIG_PM_WAKELOCKS=y
        CONFIG_BLOCK_LEGACY_AUTOLOAD=n
        EOF
        
        # Set Local Version sesuai request
        scripts/config --file "$DEFCONFIG" --set-str LOCALVERSION "-Zixine-Elysium-Wild-V1.2"

    - name: Build Kernel (GKI)
      working-directory: android-kernel
      run: |
        echo "Mulai Build Kernel..."
        
        # Tambahkan path Clang secara eksplisit ke system PATH
        # Ini memastikan 'clang' command dikenali
        export PATH="$CLANG_BIN_PATH:$PATH"
        
        echo "Checking Clang Version..."
        clang --version || echo "Clang command still not found, checking symlink logic..."
        
        export LTO=thin
        export BUILD_CONFIG=common/build.config.gki.aarch64
        
        # Menggunakan build.sh langsung
        build/build.sh -j$(nproc)

    - name: Package AnyKernel3
      working-directory: android-kernel
      run: |
        echo "Cloning AnyKernel3 (zixine)..."
        git clone https://github.com/zixine/anykernel.git anykernel
        
        echo "Mencari file Image hasil build..."
        find out -name Image -type f -exec cp {} anykernel/ \;
        
        echo "Memeriksa apakah Image berhasil disalin..."
        if [ ! -f anykernel/Image ]; then
          echo "ERROR: File Image tidak ditemukan! Cek log build."
          exit 1
        fi
        
        echo "Membuat Zip AnyKernel3..."
        cd anykernel
        rm -rf .git
        # Nama Zip disesuaikan dengan nama kernel
        zip -r9 ../AnyKernel3-Zixine-Elysium-Wild-V1.2.zip * -x README.md
        echo "Zip berhasil dibuat: AnyKernel3-Zixine-Elysium-Wild-V1.2.zip"

    - name: Upload Image Artifact
      uses: actions/upload-artifact@v4
      with:
        name: Image-WildKSU
        path: android-kernel/out/**/dist/Image

    - name: Upload AnyKernel3 Zip
      uses: actions/upload-artifact@v4
      with:
        name: AnyKernel3-Zip
        path: android-kernel/AnyKernel3-Zixine-Elysium-Wild-V1.2.zip

    - name: Release to External Repository
      uses: softprops/action-gh-release@v2
      if: success()
      with:
        token: ${{ secrets.RELEASE_TOKEN }}
        repository: zixine/Kernel-GKI-12-5.10-release
        tag_name: "v${{ github.run_number }}-wildksu"
        name: "WildKSU GKI Build v${{ github.run_number }}"
        body: |
          ## Wild KernelSU GKI Build
          
          **Android Version**: ${{ inputs.android_version }}
          **Kernel Name**: Zixine-Elysium-Wild-V1.2
          **Build ID**: ${{ github.run_number }}
          
          ### Features Included:
          - KernelSU (Wild Version)
          - SuSFS Stealth Mode Enabled
          - Xiaomi Compatibility Patches
          - Clang 20 Optimized
          
          _Automated build release._
        files: |
          android-kernel/AnyKernel3-Zixine-Elysium-Wild-V1.2.zip
          android-kernel/out/**/dist/Image
