name: Zixine GKI Builder (Stable & Fix Bootloop)

on:
  workflow_dispatch:
    inputs:
      kernel_name:
        description: 'Nama Kernel'
        required: false
        default: 'Zixine-Elysium'
        type: string
      clang_version:
        description: 'Versi Compiler Clang'
        required: true
        type: choice
        default: 'r547379 (Clang 20)'
        options:
          - 'r536225 (Clang 19)'
          - 'r547379 (Clang 20)'
          - 'r589343 (Clang 21)'
      android_version:
        description: "Versi Android Common Kernel"
        required: true
        default: "common-android12-5.10"

jobs:
  build-kernel:
    name: Build Kernel
    runs-on: ubuntu-22.04
    permissions:
      contents: write

    steps:
    - name: Environment Preparation
      uses: easimon/maximize-build-space@master
      with:
        root-reserve-mb: 8192
        swap-size-mb: 10240
        remove-dotnet: 'true'
        remove-android: 'true'
        remove-codeql: 'true'

    - name: Checkout Workflow
      uses: actions/checkout@v4

    - name: Install Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y git curl repo build-essential bc bison flex libssl-dev \
          libelf-dev python3 python3-pip unzip zip rsync libncurses-dev lld ccache \
          cmake ninja-build

    - name: Setup Git Config
      run: |
        git config --global user.email "bot@github.com"
        git config --global user.name "Zixine Builder"

    - name: Initialize & Sync Kernel Source
      run: |
        mkdir -p android-kernel
        cd android-kernel
        repo init --depth=1 -u https://android.googlesource.com/kernel/manifest -b ${{ inputs.android_version }}
        repo sync -c -j$(nproc --all) --no-tags --fail-fast

    - name: Setup Compiler (Dynamic Clang)
      working-directory: android-kernel
      run: |
        # Logika pemilihan Clang dari script zixine
        INPUT_VER="${{ inputs.clang_version }}"
        if [[ "$INPUT_VER" == *"Clang 19"* ]]; then
            TC_TAG="clang-r536225"
            TC_URL="https://android.googlesource.com/platform/prebuilts/clang/host/linux-x86/+archive/refs/heads/main-kernel-2025/clang-r536225.tar.gz"
        elif [[ "$INPUT_VER" == *"Clang 21"* ]]; then
            TC_TAG="clang-r589343"
            TC_URL="https://android.googlesource.com/platform/prebuilts/clang/host/linux-x86/+archive/refs/heads/main/clang-r589343.tar.gz"
        else
            # Default Clang 20
            TC_TAG="clang-r547379"
            TC_URL="https://android.googlesource.com/platform/prebuilts/clang/host/linux-x86/+archive/62cdcefa89e31af2d72c366e8b5ef8db84caea62/clang-r547379.tar.gz"
        fi

        mkdir -p prebuilts-master/clang/host/linux-x86/$TC_TAG
        echo "Downloading $TC_TAG..."
        curl -L "$TC_URL" | tar -xz -C prebuilts-master/clang/host/linux-x86/$TC_TAG
        
        # Symlink trick
        cd common
        OLD_CLANG_VER=$(grep "CLANG_VERSION=" build.config.common | head -n 1 | cut -d= -f2 | tr -d '"' | tr -d ' ')
        [ -z "$OLD_CLANG_VER" ] && OLD_CLANG_VER="r416183b"
        [[ "$OLD_CLANG_VER" != clang-* ]] && OLD_CLANG_DIR_NAME="clang-$OLD_CLANG_VER" || OLD_CLANG_DIR_NAME="$OLD_CLANG_VER"
        cd ..

        cd prebuilts-master/clang/host/linux-x86
        rm -rf "$OLD_CLANG_DIR_NAME"
        ln -sf "$TC_TAG" "$OLD_CLANG_DIR_NAME"
        
        echo "CLANG_BIN_PATH=$GITHUB_WORKSPACE/android-kernel/prebuilts-master/clang/host/linux-x86/$TC_TAG/bin" >> $GITHUB_ENV

    - name: Clean & Setup Wild KernelSU
      working-directory: android-kernel/common
      run: |
        echo "üßπ Membersihkan driver KernelSU lama (Pencegah Konflik/Bootloop)..."
        rm -rf drivers/staging/kernelsu drivers/kernelsu KernelSU
        
        echo "‚¨áÔ∏è Setup Wild KernelSU..."
        curl -LSs "https://raw.githubusercontent.com/WildKernels/Wild_KSU/wild/kernel/setup.sh" | bash -s wild

    - name: Setup SuSFS
      working-directory: android-kernel/common
      run: |
        git clone https://gitlab.com/simonpunk/susfs4ksu.git -b gki-android12-5.10 susfs-git
        cp -r susfs-git/kernel_patches/include/* include/
        cp -r susfs-git/kernel_patches/fs/* fs/
        cp susfs-git/kernel_patches/50_add_susfs_in_gki-android12-5.10.patch .
        patch -p1 < 50_add_susfs_in_gki-android12-5.10.patch

    - name: Apply Critical Bootloop Fixes
      working-directory: android-kernel/common
      run: |
        echo "üîß Fixing Stack Protector & Xiaomi Compat..."
        # Patch Kconfig untuk Stack Protector (Sering bikin bootloop di GKI Custom)
        sed -i '/config STACKPROTECTOR_PER_TASK/{n;s/def_bool y/bool "Stack Protector per task"\n\tdefault y/;}' arch/arm64/Kconfig
        
        # Patch Xiaomi
        sed -i '/pr_warn.*disagrees about version of symbol.*/,+1 s/.*/return 1;/' kernel/module.c
        sed -i '/^static int drm_atomic_check_valid_clones/,/^}/d' drivers/gpu/drm/drm_atomic_helper.c
        sed -i '/ret = drm_atomic_check_valid_clones/,/return ret;/d' drivers/gpu/drm/drm_atomic_helper.c
        
        # Matikan check_defconfig
        sed -i 's/check_defconfig//' build.config.gki

    - name: Configure Kernel (Safe Mode)
      working-directory: android-kernel/common
      run: |
        DEFCONFIG="arch/arm64/configs/gki_defconfig"
        
        # --- KONFIGURASI AMAN (Anti-Bootloop) ---
        # Kita tidak mematikan HARDENED_USERCOPY agar simbol driver vendor tetap ada
        
        cat <<EOF >> "$DEFCONFIG"
        CONFIG_KSU=y
        CONFIG_KPM=n
        CONFIG_KSU_MANUAL_HOOK=y
        CONFIG_KSU_KPROBES_HOOK=n
        
        # SuSFS
        CONFIG_KSU_SUSFS=y
        CONFIG_KSU_SUSFS_HAS_MAGIC_MOUNT=y
        CONFIG_KSU_SUSFS_SUS_PATH=y
        CONFIG_KSU_SUSFS_SUS_MOUNT=y
        CONFIG_KSU_SUSFS_AUTO_ADD_SUS_KSU_DEFAULT_MOUNT=y
        CONFIG_KSU_SUSFS_AUTO_ADD_SUS_BIND_MOUNT=y
        CONFIG_KSU_SUSFS_SUS_KSTAT=y
        CONFIG_KSU_SUSFS_SUS_OVERLAYFS=y
        CONFIG_KSU_SUSFS_TRY_UMOUNT=y
        CONFIG_KSU_SUSFS_AUTO_ADD_TRY_UMOUNT_FOR_BIND_MOUNT=y
        CONFIG_KSU_SUSFS_SPOOF_UNAME=y
        CONFIG_KSU_SUSFS_ENABLE_LOG=y
        CONFIG_KSU_SUSFS_HIDE_KSU_SUSFS_SYMBOLS=y
        CONFIG_KSU_SUSFS_SPOOF_CMDLINE_OR_BOOTCONFIG=y
        CONFIG_KSU_SUSFS_OPEN_REDIRECT=y
        CONFIG_KSU_SUSFS_SUS_SU=y
        CONFIG_KSU_SUSFS_SUS_KSTAT_SPOOF_GENERIC=y
        CONFIG_KSU_SUSFS_AUTO_ADD_SUS_KSTAT=y
        
        # Power & Safety
        CONFIG_HZ_300=y
        CONFIG_FS_ENCRYPTION=y
        CONFIG_FS_VERITY=y
        CONFIG_PM_AUTOSLEEP=y
        CONFIG_PM_WAKELOCKS=y
        
        # Bootloop Prevention
        # CONFIG_STACKPROTECTOR_PER_TASK is not set
        CONFIG_LOCALVERSION_AUTO=n
        EOF
        
        # --- FIX NAMA KERNEL ---
        # Menggunakan metode 'zixine' (Timpa Makefile) untuk menghindari limit 64-char
        NAME="${{ inputs.kernel_name }}"
        echo "" > scripts/setlocalversion
        
        # Cek apakah Makefile punya EXTRAVERSION, kalau ada ganti, kalau tidak tambah
        if grep -q '^EXTRAVERSION *=' Makefile; then
          sed -i "s/^EXTRAVERSION *=.*/EXTRAVERSION = -${NAME}-Wild-V1.2/" Makefile
        else
          echo "EXTRAVERSION = -${NAME}-Wild-V1.2" >> Makefile
        fi

    - name: Build Kernel
      working-directory: android-kernel
      run: |
        echo "Mulai Build Kernel..."
        export PATH="$CLANG_BIN_PATH:$PATH"
        export LTO=thin
        export BUILD_CONFIG=common/build.config.gki.aarch64
        
        # Disable Strict ABI Check (Wajib untuk custom GKI)
        export KMI_SYMBOL_LIST_STRICT_MODE=0
        export KMI_ENFORCED=0
        export TRIM_NONLISTED_KMI=0
        
        build/build.sh -j$(nproc)

    - name: Package AnyKernel3
      working-directory: android-kernel
      run: |
        git clone https://github.com/zixine/anykernel.git anykernel
        
        cp out/**/dist/Image anykernel/
        if [ ! -f anykernel/Image ]; then
          echo "ERROR: Image tidak ditemukan!"
          exit 1
        fi
        
        # Nama Zip Otomatis
        KNAME="${{ inputs.kernel_name }}"
        DATE=$(date +"%Y%m%d")
        ZIP_NAME="AnyKernel3-${KNAME}-Wild-V1.2-${DATE}.zip"
        
        cd anykernel
        rm -rf .git
        zip -r9 "../$ZIP_NAME" * -x README.md
        
        # Simpan nama file ke Env
        echo "ZIP_FILENAME=$ZIP_NAME" >> $GITHUB_ENV

    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: Kernel-Build-Result
        path: |
          android-kernel/*.zip
          android-kernel/out/**/dist/Image

    - name: Release to GitHub
      if: success()
      env:
        GH_TOKEN: ${{ secrets.RELEASE_TOKEN }}
      working-directory: android-kernel
      run: |
        REPO="zixine/Kernel-GKI-12-5.10-release"
        TAG_NAME="v${{ github.run_number }}-stable"
        ZIP_FILE="${{ env.ZIP_FILENAME }}"
        
        # Menggunakan 'gh' CLI (Lebih stabil dari softprops)
        echo "Membuat Release: $TAG_NAME..."
        gh release create "$TAG_NAME" "$ZIP_FILE" \
           --repo "$REPO" \
           --title "Zixine Wild KSU v${{ github.run_number }} (Stable)" \
           --notes "Build Date: $(date)
           Clang: ${{ inputs.clang_version }}
           **Bootloop Fixed**: Reverted aggressive optimizations & Patched Stack Protector."
